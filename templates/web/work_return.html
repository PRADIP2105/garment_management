{% extends 'base.html' %}

{% block title %}Work Return - Garment Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-undo"></i> Work Return</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReturnModal">
        <i class="fas fa-plus"></i> Record Return
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="returnsTable">
                <thead>
                    <tr>
                        <th>Worker</th>
                        <th>Work Type</th>
                        <th>Completed Qty</th>
                        <th>Pending Qty</th>
                        <th>Return Date</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center">Loading work returns...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Return Modal -->
<div class="modal fade" id="addReturnModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Work Return</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addReturnForm">
                    <div class="mb-3">
                        <label for="work_distribution" class="form-label">Work Distribution *</label>
                        <select class="form-control" id="work_distribution" required onchange="loadDistributionDetails()">
                            <option value="">Select Work Distribution</option>
                        </select>
                    </div>
                    
                    <div id="distributionDetails" style="display: none;">
                        <div class="alert alert-info">
                            <h6>Distribution Details:</h6>
                            <div id="distributionInfo"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="completed_quantity" class="form-label">Completed Quantity *</label>
                                    <input type="number" class="form-control" id="completed_quantity" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="pending_quantity" class="form-label">Pending Quantity *</label>
                                    <input type="number" class="form-control" id="pending_quantity" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="return_date" class="form-label">Return Date *</label>
                                    <input type="date" class="form-control" id="return_date" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea class="form-control" id="remarks" rows="2"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Returned Materials</h6>
                            <div id="returnedMaterialsContainer">
                                <!-- Materials will be populated here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addReturn()">Record Return</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let returns = [];
let distributions = [];
let selectedDistribution = null;

async function loadData() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login/';
        return;
    }
    
    try {
        // Load returns
        const returnsResponse = await fetch('/api/work/returns/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (returnsResponse.ok) {
            const returnsData = await returnsResponse.json();
            returns = returnsData.results || [];
            renderReturns();
        }
        
        // Load pending distributions
        const distributionsResponse = await fetch('/api/work/distributions/?status=pending,in_progress,partially_returned', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (distributionsResponse.ok) {
            const distributionsData = await distributionsResponse.json();
            distributions = distributionsData.results || [];
            populateDistributionDropdown();
        }
        
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function renderReturns() {
    const tbody = document.querySelector('#returnsTable tbody');
    
    if (returns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No work returns found</td></tr>';
        return;
    }
    
    tbody.innerHTML = returns.map(ret => `
        <tr>
            <td>${ret.worker_name}</td>
            <td>${ret.work_type_name}</td>
            <td>${ret.completed_quantity}</td>
            <td>${ret.pending_quantity}</td>
            <td>${ret.return_date}</td>
            <td>${ret.remarks || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="viewReturn(${ret.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function populateDistributionDropdown() {
    const select = document.getElementById('work_distribution');
    select.innerHTML = '<option value="">Select Work Distribution</option>';
    distributions.forEach(dist => {
        const totalReturned = dist.returns ? dist.returns.reduce((sum, ret) => sum + ret.completed_quantity, 0) : 0;
        const remaining = dist.lot_size - totalReturned;
        if (remaining > 0) {
            select.innerHTML += `<option value="${dist.id}">${dist.worker_name} - ${dist.work_type_name} (${remaining} pending)</option>`;
        }
    });
}

function loadDistributionDetails() {
    const distributionId = document.getElementById('work_distribution').value;
    if (!distributionId) {
        document.getElementById('distributionDetails').style.display = 'none';
        return;
    }
    
    selectedDistribution = distributions.find(d => d.id == distributionId);
    if (!selectedDistribution) return;
    
    // Calculate remaining quantity
    const totalReturned = selectedDistribution.returns ? 
        selectedDistribution.returns.reduce((sum, ret) => sum + ret.completed_quantity, 0) : 0;
    const remaining = selectedDistribution.lot_size - totalReturned;
    
    // Show distribution details
    document.getElementById('distributionInfo').innerHTML = `
        <strong>Worker:</strong> ${selectedDistribution.worker_name}<br>
        <strong>Work Type:</strong> ${selectedDistribution.work_type_name}<br>
        <strong>Total Lot Size:</strong> ${selectedDistribution.lot_size}<br>
        <strong>Already Returned:</strong> ${totalReturned}<br>
        <strong>Remaining:</strong> ${remaining}
    `;
    
    // Set max values
    document.getElementById('completed_quantity').max = remaining;
    document.getElementById('pending_quantity').max = remaining;
    
    // Populate returned materials
    populateReturnedMaterials();
    
    document.getElementById('distributionDetails').style.display = 'block';
}

function populateReturnedMaterials() {
    const container = document.getElementById('returnedMaterialsContainer');
    
    if (!selectedDistribution.materials || selectedDistribution.materials.length === 0) {
        container.innerHTML = '<p class="text-muted">No materials were distributed with this work.</p>';
        return;
    }
    
    container.innerHTML = selectedDistribution.materials.map((material, index) => `
        <div class="row mb-2">
            <div class="col-md-4">
                <label class="form-label">${material.material_name}</label>
                <input type="hidden" name="material_id_${index}" value="${material.material}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Returned Qty</label>
                <input type="number" step="0.01" class="form-control" name="returned_quantity_${index}" 
                       placeholder="0.00" max="${material.issued_quantity}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Wastage Qty</label>
                <input type="number" step="0.01" class="form-control" name="wastage_quantity_${index}" 
                       placeholder="0.00" max="${material.issued_quantity}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Unit</label>
                <input type="text" class="form-control" value="${material.material_unit}" readonly>
            </div>
        </div>
    `).join('');
}

async function addReturn() {
    const token = localStorage.getItem('access_token');
    
    // Collect returned materials data
    const materialsData = [];
    if (selectedDistribution.materials) {
        selectedDistribution.materials.forEach((material, index) => {
            const returnedQty = document.querySelector(`[name="returned_quantity_${index}"]`).value;
            const wastageQty = document.querySelector(`[name="wastage_quantity_${index}"]`).value;
            
            if (returnedQty || wastageQty) {
                materialsData.push({
                    material: material.material,
                    returned_quantity: parseFloat(returnedQty) || 0,
                    wastage_quantity: parseFloat(wastageQty) || 0
                });
            }
        });
    }
    
    const formData = {
        work_distribution: document.getElementById('work_distribution').value,
        completed_quantity: document.getElementById('completed_quantity').value,
        pending_quantity: document.getElementById('pending_quantity').value,
        return_date: document.getElementById('return_date').value,
        remarks: document.getElementById('remarks').value,
        materials: materialsData
    };
    
    try {
        const response = await fetch('/api/work/returns/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addReturnModal'));
            modal.hide();
            document.getElementById('addReturnForm').reset();
            document.getElementById('distributionDetails').style.display = 'none';
            loadData();
            showSuccess('Work return recorded successfully!');
        } else {
            const errorData = await response.json();
            alert('Error recording return: ' + JSON.stringify(errorData));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

function viewReturn(id) {
    alert('View return details coming soon!');
}

function showSuccess(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.card'));
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('return_date').value = today;
    loadData();
});
</script>
{% endblock %}